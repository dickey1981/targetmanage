# è…¾è®¯äº‘éƒ¨ç½²æŒ‡å—

æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»å¦‚ä½•å°†ç›®æ ‡ç®¡ç†ç³»ç»Ÿéƒ¨ç½²åˆ°è…¾è®¯äº‘ï¼Œå¹¶ä½¿ç”¨è…¾è®¯äº‘æ•°æ®åº“è¿›è¡Œå¼€å‘ã€‚

## ğŸ—ï¸ æ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        è…¾è®¯äº‘æ¶æ„                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  CLB (è´Ÿè½½å‡è¡¡)                                             â”‚
â”‚    â”œâ”€â”€ åŸŸå: targetmanage.example.com                       â”‚
â”‚    â””â”€â”€ SSLè¯ä¹¦                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  CVM (äº‘æœåŠ¡å™¨)                                             â”‚
â”‚    â”œâ”€â”€ åç«¯æœåŠ¡ (FastAPI) - 8000ç«¯å£                        â”‚
â”‚    â”œâ”€â”€ å‰ç«¯æœåŠ¡ (Nginx) - 80/443ç«¯å£                       â”‚
â”‚    â””â”€â”€ Redis (æœ¬åœ°æˆ–äº‘Redis)                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  TencentDB for PostgreSQL                                  â”‚
â”‚    â”œâ”€â”€ ä¸»å®ä¾‹: è¯»å†™                                         â”‚
â”‚    â””â”€â”€ åªè¯»å®ä¾‹: è¯»å– (å¯é€‰)                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  è…¾è®¯äº‘AIæœåŠ¡                                               â”‚
â”‚    â”œâ”€â”€ OCRæ–‡å­—è¯†åˆ«                                          â”‚
â”‚    â”œâ”€â”€ ASRè¯­éŸ³è¯†åˆ«                                          â”‚
â”‚    â””â”€â”€ COSå¯¹è±¡å­˜å‚¨ (æ–‡ä»¶å­˜å‚¨)                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç›‘æ§å‘Šè­¦                                                   â”‚
â”‚    â”œâ”€â”€ äº‘ç›‘æ§                                              â”‚
â”‚    â””â”€â”€ æ—¥å¿—æœåŠ¡ CLS                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“‹ å‰ç½®å‡†å¤‡

### 1. è…¾è®¯äº‘è´¦å·å’Œæƒé™
- æ³¨å†Œè…¾è®¯äº‘è´¦å·
- å¼€é€šä»¥ä¸‹æœåŠ¡ï¼š
  - äº‘æœåŠ¡å™¨ CVM
  - äº‘æ•°æ®åº“ TencentDB for PostgreSQL
  - äº‘æ•°æ®åº“ Redis
  - å¯¹è±¡å­˜å‚¨ COS
  - æ–‡å­—è¯†åˆ« OCR
  - è¯­éŸ³è¯†åˆ« ASR
  - è´Ÿè½½å‡è¡¡ CLB
  - SSLè¯ä¹¦

### 2. åŸŸåå’ŒSSLè¯ä¹¦
- è´­ä¹°åŸŸåå¹¶å®Œæˆå¤‡æ¡ˆ
- ç”³è¯·SSLè¯ä¹¦

### 3. å¼€å‘å·¥å…·
- è…¾è®¯äº‘CLIå·¥å…·
- Docker
- Git

## ğŸ—„ï¸ æ•°æ®åº“é…ç½®

### 1. åˆ›å»ºPostgreSQLå®ä¾‹

```bash
# ä½¿ç”¨è…¾è®¯äº‘CLIåˆ›å»ºPostgreSQLå®ä¾‹
tccli postgres CreateDBInstances \
    --region ap-beijing \
    --zone ap-beijing-1 \
    --memory 2 \
    --storage 50 \
    --instancecount 1 \
    --period 1 \
    --username postgres \
    --password "YourStrongPassword123!" \
    --dbversion 13.3 \
    --instancename "targetmanage-db"
```

### 2. æ•°æ®åº“è¿æ¥é…ç½®

æ›´æ–° `backend/.env` æ–‡ä»¶ï¼š

```env
# è…¾è®¯äº‘PostgreSQLé…ç½®
DATABASE_URL=postgresql://postgres:YourPassword@your-db-host:5432/targetmanage
DATABASE_TEST_URL=postgresql://postgres:YourPassword@your-db-host:5432/targetmanage_test

# è…¾è®¯äº‘Redisé…ç½®
REDIS_URL=redis://:password@your-redis-host:6379/0
```

### 3. æ•°æ®åº“å®‰å…¨é…ç½®

```sql
-- åˆ›å»ºåº”ç”¨ä¸“ç”¨æ•°æ®åº“ç”¨æˆ·
CREATE USER targetmanage_user WITH PASSWORD 'app_user_password';

-- åˆ›å»ºæ•°æ®åº“
CREATE DATABASE targetmanage OWNER targetmanage_user;
CREATE DATABASE targetmanage_test OWNER targetmanage_user;

-- æˆæƒ
GRANT ALL PRIVILEGES ON DATABASE targetmanage TO targetmanage_user;
GRANT ALL PRIVILEGES ON DATABASE targetmanage_test TO targetmanage_user;
```

## ğŸš€ æœåŠ¡å™¨éƒ¨ç½²

### 1. CVMæœåŠ¡å™¨é…ç½®

æ¨èé…ç½®ï¼š
- **å®ä¾‹è§„æ ¼**: æ ‡å‡†å‹S5.LARGE8 (4æ ¸8GB)
- **æ“ä½œç³»ç»Ÿ**: Ubuntu 20.04 LTS
- **ç³»ç»Ÿç›˜**: é«˜æ€§èƒ½äº‘ç¡¬ç›˜ 50GB
- **ç½‘ç»œ**: VPCç½‘ç»œï¼Œåˆ†é…å…¬ç½‘IP

### 2. æœåŠ¡å™¨ç¯å¢ƒå‡†å¤‡

```bash
#!/bin/bash
# æœåŠ¡å™¨åˆå§‹åŒ–è„šæœ¬

# æ›´æ–°ç³»ç»Ÿ
sudo apt update && sudo apt upgrade -y

# å®‰è£…åŸºç¡€è½¯ä»¶
sudo apt install -y curl wget git vim nginx

# å®‰è£…Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh
sudo usermod -aG docker $USER

# å®‰è£…Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# å®‰è£…Node.js (ç”¨äºå‰ç«¯æ„å»º)
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# å®‰è£…Python
sudo apt install -y python3 python3-pip python3-venv
```

### 3. é¡¹ç›®éƒ¨ç½²

```bash
# å…‹éš†é¡¹ç›®
git clone https://github.com/your-repo/targetmanage.git
cd targetmanage

# é…ç½®ç¯å¢ƒå˜é‡
cp backend/.env.example backend/.env.production
# ç¼–è¾‘ç”Ÿäº§ç¯å¢ƒé…ç½®

# æ„å»ºå’Œå¯åŠ¨æœåŠ¡
docker-compose -f docker-compose.prod.yml up -d
```

## ğŸ”§ è…¾è®¯äº‘æœåŠ¡é…ç½®

### 1. å¯¹è±¡å­˜å‚¨ COS

```python
# backend/app/config/tencent_cloud.py
from qcloud_cos import CosConfig, CosS3Client
from app.config.settings import settings

# COSé…ç½®
cos_config = CosConfig(
    Region=settings.TENCENT_REGION,
    SecretId=settings.TENCENT_SECRET_ID,
    SecretKey=settings.TENCENT_SECRET_KEY
)

cos_client = CosS3Client(cos_config)
```

### 2. OCRæ–‡å­—è¯†åˆ«

```python
# backend/app/services/tencent_ocr_service.py
from tencentcloud.common import credential
from tencentcloud.ocr.v20181119 import ocr_client, models

class TencentOCRService:
    def __init__(self):
        cred = credential.Credential(
            settings.TENCENT_SECRET_ID,
            settings.TENCENT_SECRET_KEY
        )
        self.client = ocr_client.OcrClient(cred, settings.TENCENT_REGION)
    
    async def general_basic_ocr(self, image_base64: str):
        """é€šç”¨æ–‡å­—è¯†åˆ«"""
        req = models.GeneralBasicOCRRequest()
        req.ImageBase64 = image_base64
        
        resp = self.client.GeneralBasicOCR(req)
        return resp.TextDetections
```

### 3. è¯­éŸ³è¯†åˆ« ASR

```python
# backend/app/services/tencent_asr_service.py
from tencentcloud.asr.v20190614 import asr_client, models

class TencentASRService:
    def __init__(self):
        cred = credential.Credential(
            settings.TENCENT_SECRET_ID,
            settings.TENCENT_SECRET_KEY
        )
        self.client = asr_client.AsrClient(cred, settings.TENCENT_REGION)
    
    async def sentence_recognition(self, audio_data: bytes):
        """ä¸€å¥è¯è¯†åˆ«"""
        req = models.SentenceRecognitionRequest()
        req.ProjectId = 0
        req.SubServiceType = 2
        req.EngSerViceType = "16k_zh"
        req.SourceType = 1
        req.Data = audio_data
        
        resp = self.client.SentenceRecognition(req)
        return resp.Result
```

## ğŸ“¦ ç”Ÿäº§ç¯å¢ƒDockeré…ç½®

åˆ›å»º `docker-compose.prod.yml`ï¼š

```yaml
version: '3.8'

services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.prod
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - DEBUG=False
      - TENCENT_SECRET_ID=${TENCENT_SECRET_ID}
      - TENCENT_SECRET_KEY=${TENCENT_SECRET_KEY}
    ports:
      - "8000:8000"
    restart: unless-stopped
    volumes:
      - ./logs:/app/logs
    
  frontend:
    build:
      context: ./admin-frontend
      dockerfile: Dockerfile.prod
    ports:
      - "3000:80"
    restart: unless-stopped
    
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.prod.conf:/etc/nginx/nginx.conf
      - ./nginx/ssl:/etc/nginx/ssl
    depends_on:
      - backend
      - frontend
    restart: unless-stopped
```

## ğŸ”’ å®‰å…¨é…ç½®

### 1. é˜²ç«å¢™é…ç½®

```bash
# é…ç½®ufwé˜²ç«å¢™
sudo ufw enable
sudo ufw allow ssh
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw deny 8000/tcp  # åç«¯æœåŠ¡åªå…è®¸å†…éƒ¨è®¿é—®
```

### 2. SSLè¯ä¹¦é…ç½®

```nginx
# nginx/nginx.prod.conf
server {
    listen 443 ssl http2;
    server_name targetmanage.example.com;
    
    ssl_certificate /etc/nginx/ssl/cert.pem;
    ssl_certificate_key /etc/nginx/ssl/key.pem;
    
    location / {
        proxy_pass http://frontend:80;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
    
    location /api {
        proxy_pass http://backend:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

### 1. äº‘ç›‘æ§é…ç½®

```python
# backend/app/utils/monitoring.py
from tencentcloud.monitor.v20180724 import monitor_client, models

class CloudMonitoring:
    def __init__(self):
        self.client = monitor_client.MonitorClient(cred, region)
    
    def send_custom_metric(self, metric_name: str, value: float):
        """å‘é€è‡ªå®šä¹‰æŒ‡æ ‡"""
        req = models.PutMonitorDataRequest()
        req.Metrics = [
            {
                "MetricName": metric_name,
                "Value": value,
                "Timestamp": int(time.time())
            }
        ]
        self.client.PutMonitorData(req)
```

### 2. æ—¥å¿—æœåŠ¡CLS

```python
# backend/app/utils/cls_logger.py
import json
from tencentcloud.cls.v20201016 import cls_client, models

class CLSLogger:
    def __init__(self):
        self.client = cls_client.ClsClient(cred, region)
        self.topic_id = settings.CLS_TOPIC_ID
    
    def send_log(self, level: str, message: str, extra_data: dict = None):
        """å‘é€æ—¥å¿—åˆ°CLS"""
        log_data = {
            "timestamp": int(time.time() * 1000),
            "level": level,
            "message": message,
            "service": "targetmanage-backend"
        }
        if extra_data:
            log_data.update(extra_data)
        
        req = models.UploadLogRequest()
        req.TopicId = self.topic_id
        req.HashKey = "targetmanage"
        req.CompressType = "gzip"
        req.LogData = json.dumps([log_data])
        
        self.client.UploadLog(req)
```

## ğŸš€ è‡ªåŠ¨åŒ–éƒ¨ç½²

### 1. GitHub Actions CI/CD

```yaml
# .github/workflows/deploy.yml
name: Deploy to Tencent Cloud

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      
      - name: Deploy to server
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            cd /opt/targetmanage
            git pull origin main
            docker-compose -f docker-compose.prod.yml down
            docker-compose -f docker-compose.prod.yml up -d --build
```

### 2. éƒ¨ç½²è„šæœ¬

```bash
#!/bin/bash
# scripts/tencent-cloud/deploy.sh

set -e

echo "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ°è…¾è®¯äº‘..."

# æ›´æ–°ä»£ç 
git pull origin main

# æ„å»ºé•œåƒ
docker-compose -f docker-compose.prod.yml build

# æ•°æ®åº“è¿ç§»
docker-compose -f docker-compose.prod.yml run --rm backend alembic upgrade head

# é‡å¯æœåŠ¡
docker-compose -f docker-compose.prod.yml down
docker-compose -f docker-compose.prod.yml up -d

echo "âœ… éƒ¨ç½²å®Œæˆï¼"
```

## ğŸ’° æˆæœ¬ä¼°ç®—

### æœˆåº¦è´¹ç”¨é¢„ä¼°ï¼ˆåŒ—äº¬åœ°åŸŸï¼‰

| æœåŠ¡ | è§„æ ¼ | æœˆè´¹ç”¨ |
|------|------|--------|
| CVMäº‘æœåŠ¡å™¨ | 4æ ¸8GB | Â¥200-300 |
| PostgreSQL | 2æ ¸4GB | Â¥150-250 |
| Redis | 1GB | Â¥50-100 |
| CLBè´Ÿè½½å‡è¡¡ | æ ‡å‡†å‹ | Â¥20-50 |
| COSå­˜å‚¨ | 10GB | Â¥5-10 |
| OCRè°ƒç”¨ | 1000æ¬¡/æœˆ | Â¥10-20 |
| ASRè°ƒç”¨ | 100å°æ—¶/æœˆ | Â¥30-50 |
| **æ€»è®¡** | | **Â¥465-780** |

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚é‡åˆ°éƒ¨ç½²é—®é¢˜ï¼Œå¯ä»¥ï¼š
1. æŸ¥çœ‹è…¾è®¯äº‘å®˜æ–¹æ–‡æ¡£
2. è”ç³»è…¾è®¯äº‘æŠ€æœ¯æ”¯æŒ
3. åœ¨é¡¹ç›®Issuesä¸­æé—®

---

**æ³¨æ„**: è¯·å¦¥å–„ä¿ç®¡è…¾è®¯äº‘å¯†é’¥ï¼Œä¸è¦å°†æ•æ„Ÿä¿¡æ¯æäº¤åˆ°ä»£ç ä»“åº“ä¸­ã€‚
