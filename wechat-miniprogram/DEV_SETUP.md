# 微信小程序开发环境配置指南

## 📋 当前状态

- ✅ 后端服务器：`http://106.54.212.67` (正常运行)
- ⏳ HTTPS域名：`https://targetmanage.cn` (ICP备案中，暂不可用)
- 🔧 开发模式：使用HTTP+IP进行开发调试

## 🚀 快速开始

### 1. 微信开发者工具配置

#### 1.1 关闭域名校验（开发必须）

由于开发环境使用HTTP协议，需要关闭域名校验：

1. 打开微信开发者工具
2. 点击右上角 **"详情"**
3. 选择 **"本地设置"** 标签
4. ✅ **勾选** "不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书"

> ⚠️ **重要**：如果不勾选此选项，HTTP请求将被拦截！

#### 1.2 清除缓存

1. 点击工具栏 **"清缓存"**
2. 选择 **"清除全部缓存"**
3. 重新编译项目

### 2. 环境配置说明

当前配置文件：`config/env.js`

```javascript
const ENV = {
  // 开发环境（开发者工具中使用）
  development: {
    baseUrl: 'http://106.54.212.67',  // HTTP+IP
    apiVersion: 'v1',
    debug: true
  },
  
  // 生产环境（备案完成后使用）
  production: {
    baseUrl: 'https://targetmanage.cn',  // HTTPS域名
    apiVersion: 'v1',
    debug: false
  }
}
```

**自动环境识别**：
- 在微信开发者工具中 → 自动使用 `development` 配置
- 在真机上运行 → 自动使用 `production` 配置

### 3. 测试步骤

#### 3.1 测试服务器连接

在开发者工具的控制台中执行：

```javascript
wx.request({
  url: 'http://106.54.212.67/health',
  method: 'GET',
  success: (res) => {
    console.log('服务器健康检查:', res.data)
  },
  fail: (err) => {
    console.error('连接失败:', err)
  }
})
```

预期结果：
```json
{
  "status": "healthy",
  "timestamp": "2025-01-01T00:00:00Z",
  "service": "智能目标管理系统",
  "version": "1.0.0"
}
```

#### 3.2 测试微信登录

1. 点击首页的 **"微信授权"** 按钮
2. 查看控制台日志，确认请求发送到 `http://106.54.212.67/api/auth/wechat-login`
3. 登录成功后，token会保存到本地存储

#### 3.3 测试语音功能

1. 登录后，长按 **"按住说话"** 按钮
2. 说话后松开按钮
3. 查看语音识别结果

> 💡 当前ASR处于开发模式（`ASR_DEV_MODE=true`），会返回模拟数据

#### 3.4 测试创建目标

1. 点击 **"创建目标"** 快捷操作
2. 或使用语音说："创建一个新目标"
3. 填写目标信息并提交

## 🔍 调试技巧

### 查看网络请求

1. 开发者工具 → **"Network"** 标签
2. 查看所有API请求和响应
3. 检查请求URL是否正确（应该是 `http://106.54.212.67/api/...`）

### 查看控制台日志

代码中已添加详细的调试日志：

```javascript
// 页面加载时
console.log('页面加载 - 环境配置信息:')
console.log('全局baseUrl:', app.globalData.baseUrl)
console.log('当前环境:', wx.getSystemInfoSync().platform)

// 登录时
console.log('🔐 开始微信登录流程')
console.log('API URL:', apiUrl)
console.log('请求数据:', requestData)
```

### 常见问题

#### 1. 请求失败：`request:fail`

**原因**：未关闭域名校验

**解决**：详情 → 本地设置 → 勾选"不校验合法域名..."

#### 2. 登录失败：`appid missing`

**原因**：后端环境变量未配置

**解决**：检查服务器 `/opt/targetmanage/.env` 文件

#### 3. 语音识别失败

**原因**：ASR服务未初始化

**解决**：确认 `ASR_DEV_MODE=true` 已设置（开发模式使用模拟数据）

## 📱 真机调试

### 注意事项

⚠️ **真机无法使用HTTP协议！**

微信小程序在真机上强制要求HTTPS，因此：

1. **开发阶段**：只能在开发者工具中调试
2. **体验版/正式版**：必须等待域名备案完成后使用HTTPS

### 备案完成后

1. 修改 `config/env.js`：
   ```javascript
   development: {
     baseUrl: 'https://targetmanage.cn',  // 改回HTTPS
   }
   ```

2. 在微信公众平台配置服务器域名：
   - 登录 [微信公众平台](https://mp.weixin.qq.com)
   - 开发 → 开发管理 → 服务器域名
   - 添加：`https://targetmanage.cn`

3. 重新上传代码并提交审核

## 🛠️ 后端服务器信息

- **服务器IP**：106.54.212.67
- **HTTP端口**：80
- **HTTPS端口**：443（备案完成后可用）
- **API端口**：8000（直连，不推荐）

### API端点

- 健康检查：`http://106.54.212.67/health`
- 微信登录：`http://106.54.212.67/api/auth/wechat-login`
- 语音处理：`http://106.54.212.67/api/voice/process`
- 目标列表：`http://106.54.212.67/api/goals`

## 📝 开发清单

### 功能测试

- [ ] 微信授权登录
- [ ] 语音录音和识别
- [ ] 创建目标
- [ ] 查看目标列表
- [ ] 查看目标详情
- [ ] 更新目标进度
- [ ] 删除目标
- [ ] 拍照记录
- [ ] 数据同步

### 性能测试

- [ ] 首页加载速度
- [ ] API响应时间
- [ ] 语音识别速度
- [ ] 图片上传速度

## 🎯 下一步计划

1. ✅ 配置开发环境（当前步骤）
2. 🔄 完成所有功能开发和测试
3. ⏳ 等待域名ICP备案（15-20天）
4. 📱 配置HTTPS和小程序服务器域名
5. 🚀 提交审核并发布

## 📞 技术支持

如遇到问题，请检查：

1. **开发者工具**：是否关闭域名校验
2. **服务器状态**：`curl http://106.54.212.67/health`
3. **环境变量**：服务器上的 `.env` 文件
4. **网络连接**：是否能访问服务器IP

---

**最后更新**：2025-01-01
**文档版本**：v1.0

