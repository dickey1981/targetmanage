# 微信小程序功能测试指南

## 🎯 测试目标

完整测试小程序的所有核心功能，确保开发环境正常运行。

## ⚙️ 测试前准备

### 1. 微信开发者工具配置

✅ **必须完成以下配置**：

1. **关闭域名校验**
   - 详情 → 本地设置
   - ✅ 勾选 "不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书"

2. **清除缓存**
   - 工具栏 → 清缓存 → 清除全部缓存

3. **重新编译**
   - 点击 "编译" 按钮

### 2. 确认环境配置

打开控制台（Console），查看日志：

```
页面加载 - 环境配置信息:
全局baseUrl: http://106.54.212.67
当前环境: devtools
```

✅ 确认 `baseUrl` 是 `http://106.54.212.67`

## 📝 测试用例

### 测试1：服务器连接测试

**目的**：验证小程序能否连接到后端服务器

**步骤**：
1. 打开控制台（Console）
2. 输入以下代码：

```javascript
wx.request({
  url: 'http://106.54.212.67/health',
  method: 'GET',
  success: (res) => {
    console.log('✅ 服务器连接成功:', res.data)
  },
  fail: (err) => {
    console.error('❌ 连接失败:', err)
  }
})
```

**预期结果**：
```json
✅ 服务器连接成功: {
  "status": "healthy",
  "timestamp": "2025-01-01T00:00:00Z",
  "service": "智能目标管理系统",
  "version": "1.0.0"
}
```

**失败排查**：
- ❌ 如果失败，检查是否关闭了域名校验
- ❌ 检查网络连接

---

### 测试2：微信授权登录

**目的**：测试微信授权登录流程

**步骤**：
1. 首页应该自动弹出授权弹窗
2. 点击 **"微信授权"** 按钮
3. 观察控制台日志

**预期日志**：
```
🔐 开始微信登录流程
wx.login 成功，code: 071abc...
API URL: http://106.54.212.67/api/auth/wechat-login
请求数据: {code: "071abc...", phone_code: null, ...}
✅ 登录成功
用户信息: {id: 1, nickname: "微信用户", ...}
Token: eyJ0eXAiOiJKV1QiLCJhbGc...
```

**预期界面变化**：
- ✅ 授权弹窗关闭
- ✅ 显示用户信息（头像、昵称）
- ✅ 显示今日目标列表
- ✅ 显示快捷操作按钮

**失败排查**：
- ❌ 如果返回 `appid missing`：后端环境变量未配置
- ❌ 如果 `request:fail`：未关闭域名校验
- ❌ 如果 `invalid code`：code已过期，重新点击授权

---

### 测试3：语音录音功能

**目的**：测试语音录音和识别功能

**步骤**：
1. 确保已登录
2. 长按 **"按住说话"** 按钮
3. 说话（例如："创建一个学习目标"）
4. 松开按钮
5. 观察控制台和界面

**预期日志**：
```
🎤 开始录音
录音配置: {duration: 60000, sampleRate: 16000, ...}
⏹️ 停止录音
录音结束，文件路径: wxfile://tmp_...
📤 开始上传语音文件
上传URL: http://106.54.212.67/api/voice/process
✅ 语音识别成功
识别结果: {text: "创建一个学习目标", type: "create_goal", ...}
```

**预期界面变化**：
- ✅ 按住时：按钮变红，显示 "松开结束"
- ✅ 松开后：显示 "识别中..."
- ✅ 识别成功：弹出语音结果确认弹窗
- ✅ 显示识别的文本和操作类型

**失败排查**：
- ❌ `operateRecorder:fail`：录音权限未授权
  - 开发者工具 → 工具 → 授权管理 → 开启录音权限
- ❌ `语音识别失败`：检查后端ASR配置
- ❌ `上传失败`：检查网络和API地址

---

### 测试4：创建目标（手动）

**目的**：测试手动创建目标功能

**步骤**：
1. 点击快捷操作中的 **"创建目标"** 按钮
2. 填写目标信息：
   - 标题：测试目标
   - 描述：这是一个测试目标
   - 截止日期：选择未来日期
   - 优先级：高
3. 点击 **"创建"** 按钮

**预期日志**：
```
📝 创建目标
请求URL: http://106.54.212.67/api/goals
请求数据: {title: "测试目标", description: "这是一个测试目标", ...}
✅ 目标创建成功
目标ID: 123
```

**预期界面变化**：
- ✅ 弹窗关闭
- ✅ 显示成功提示
- ✅ 目标列表刷新，显示新创建的目标

**失败排查**：
- ❌ `401 Unauthorized`：token过期，重新登录
- ❌ `400 Bad Request`：检查必填字段
- ❌ `500 Server Error`：检查后端日志

---

### 测试5：创建目标（语音）

**目的**：测试通过语音创建目标

**步骤**：
1. 长按 **"按住说话"**
2. 说："创建一个学习Python的目标，本周完成"
3. 松开按钮
4. 在语音结果弹窗中点击 **"确认创建"**

**预期流程**：
```
🎤 录音 → 识别 → 显示结果弹窗 → 确认 → 创建目标 → 成功
```

**预期日志**：
```
✅ 语音识别成功
识别结果: {
  text: "创建一个学习Python的目标，本周完成",
  type: "create_goal",
  parsed_data: {
    title: "学习Python",
    deadline: "2025-01-07"
  }
}
用户确认创建目标
📝 创建目标...
✅ 目标创建成功
```

**失败排查**：
- ❌ 识别类型错误：优化语音指令
- ❌ 解析失败：检查后端解析逻辑

---

### 测试6：查看目标列表

**目的**：测试目标列表加载和显示

**步骤**：
1. 在首页查看 "今日目标" 列表
2. 下拉刷新
3. 点击某个目标卡片

**预期日志**：
```
📋 加载今日目标
请求URL: http://106.54.212.67/api/goals?date=2025-01-01
✅ 加载成功，共 5 个目标
```

**预期界面**：
- ✅ 显示目标卡片（标题、进度条、完成状态）
- ✅ 显示统计信息（已完成/进行中）
- ✅ 下拉刷新正常工作
- ✅ 点击卡片跳转到详情页

---

### 测试7：查看目标详情

**目的**：测试目标详情页功能

**步骤**：
1. 从列表点击某个目标
2. 查看详情页内容
3. 尝试更新进度
4. 尝试添加记录

**预期界面**：
- ✅ 显示目标完整信息（标题、描述、截止日期、优先级）
- ✅ 显示进度条和百分比
- ✅ 显示执行记录列表
- ✅ 可以更新进度
- ✅ 可以添加新记录

**预期日志**：
```
📖 加载目标详情
目标ID: 123
请求URL: http://106.54.212.67/api/goals/123
✅ 详情加载成功
```

---

### 测试8：更新目标进度

**目的**：测试更新目标进度功能

**步骤**：
1. 在目标详情页
2. 拖动进度滑块或输入进度值
3. 点击 **"保存"** 按钮

**预期日志**：
```
📊 更新目标进度
目标ID: 123
新进度: 75%
请求URL: http://106.54.212.67/api/goals/123
✅ 进度更新成功
```

**预期界面变化**：
- ✅ 进度条更新
- ✅ 显示成功提示
- ✅ 返回列表后进度已更新

---

### 测试9：删除目标

**目的**：测试删除目标功能

**步骤**：
1. 在目标详情页
2. 点击 **"删除"** 按钮
3. 确认删除

**预期日志**：
```
🗑️ 删除目标
目标ID: 123
请求URL: http://106.54.212.67/api/goals/123
方法: DELETE
✅ 删除成功
```

**预期界面变化**：
- ✅ 显示确认弹窗
- ✅ 确认后返回列表
- ✅ 目标从列表中消失

---

### 测试10：拍照记录

**目的**：测试拍照上传功能

**步骤**：
1. 点击快捷操作中的 **"拍照记录"**
2. 选择图片或拍照
3. 添加描述
4. 提交

**预期日志**：
```
📷 拍照记录
选择图片: wxfile://tmp_...
📤 上传图片
上传URL: http://106.54.212.67/api/upload
✅ 上传成功
图片URL: https://...
📝 创建记录
✅ 记录创建成功
```

**预期界面变化**：
- ✅ 显示图片预览
- ✅ 可以添加描述
- ✅ 上传成功后显示提示

---

## 📊 测试结果记录

| 测试项 | 状态 | 备注 |
|--------|------|------|
| 1. 服务器连接 | ⬜ 未测试 |  |
| 2. 微信登录 | ⬜ 未测试 |  |
| 3. 语音录音 | ⬜ 未测试 |  |
| 4. 手动创建目标 | ⬜ 未测试 |  |
| 5. 语音创建目标 | ⬜ 未测试 |  |
| 6. 目标列表 | ⬜ 未测试 |  |
| 7. 目标详情 | ⬜ 未测试 |  |
| 8. 更新进度 | ⬜ 未测试 |  |
| 9. 删除目标 | ⬜ 未测试 |  |
| 10. 拍照记录 | ⬜ 未测试 |  |

## 🐛 常见问题排查

### 问题1：所有请求都失败

**症状**：`request:fail`

**原因**：未关闭域名校验

**解决**：
1. 详情 → 本地设置
2. ✅ 勾选 "不校验合法域名..."
3. 重新编译

### 问题2：登录失败 `appid missing`

**症状**：后端返回 `appid missing`

**原因**：后端环境变量未配置

**解决**：
1. SSH连接到服务器
2. 检查 `/opt/targetmanage/.env` 文件
3. 确认 `WECHAT_APP_ID` 和 `WECHAT_APP_SECRET` 已配置
4. 重启容器：`docker-compose -f docker-compose.lighthouse.yml restart backend`

### 问题3：语音识别失败

**症状**：`语音识别服务未初始化`

**原因**：ASR配置问题

**解决**：
1. 检查 `.env` 文件中的 `ASR_DEV_MODE=true`
2. 开发模式会返回模拟数据，不需要真实的ASR密钥
3. 重启后端容器

### 问题4：Token过期

**症状**：`401 Unauthorized`

**原因**：Token已过期（30分钟有效期）

**解决**：
1. 清除本地存储
2. 重新登录

### 问题5：网络超时

**症状**：`request:fail timeout`

**原因**：网络连接慢或服务器响应慢

**解决**：
1. 检查网络连接
2. 检查服务器状态：`curl http://106.54.212.67/health`
3. 增加超时时间（代码中已设置30秒）

## 🎓 调试技巧

### 1. 使用Console调试

在控制台中直接测试API：

```javascript
// 测试登录
wx.login({
  success: (res) => {
    console.log('code:', res.code)
    wx.request({
      url: 'http://106.54.212.67/api/auth/wechat-login',
      method: 'POST',
      data: { code: res.code },
      success: (res) => console.log('登录结果:', res),
      fail: (err) => console.error('登录失败:', err)
    })
  }
})

// 测试获取目标列表
wx.request({
  url: 'http://106.54.212.67/api/goals',
  method: 'GET',
  header: {
    'Authorization': 'Bearer ' + wx.getStorageSync('token')
  },
  success: (res) => console.log('目标列表:', res),
  fail: (err) => console.error('获取失败:', err)
})
```

### 2. 查看Network面板

1. 开发者工具 → Network标签
2. 查看所有请求和响应
3. 检查请求URL、Headers、Body
4. 检查响应状态码和数据

### 3. 查看Storage

1. 开发者工具 → Storage标签
2. 查看本地存储的数据：
   - `token`：JWT令牌
   - `userInfo`：用户信息
   - 其他缓存数据

### 4. 模拟器 vs 真机

- **模拟器**：可以使用HTTP，适合开发调试
- **真机预览**：强制HTTPS，需要域名备案
- **建议**：开发阶段只在模拟器中测试

## ✅ 测试完成标准

所有测试项都通过后，开发环境配置完成，可以进行功能开发。

## 📞 需要帮助？

如果测试过程中遇到问题：

1. 查看控制台日志
2. 查看Network请求详情
3. 检查本文档的"常见问题排查"部分
4. 检查服务器日志：`docker logs targetmanage_backend_lighthouse`

---

**最后更新**：2025-01-01
**文档版本**：v1.0

