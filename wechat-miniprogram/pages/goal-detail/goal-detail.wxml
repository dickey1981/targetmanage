<!--pages/goal-detail/goal-detail.wxml-->
<view class="container">
  <!-- é¡¶éƒ¨å¯¼èˆª -->
  <view class="header">
    <view class="back-btn" bindtap="goBack">
      <text class="back-icon">â†</text>
    </view>
    <text class="title">ç›®æ ‡è¯¦æƒ…</text>
    <view class="edit-btn" bindtap="toggleEditMode">
      <text class="edit-text">{{isEditing ? 'å®Œæˆ' : 'ç¼–è¾‘'}}</text>
    </view>
  </view>

  <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
  <view class="tab-nav">
    <view class="tab-item {{selectedTab === 'overview' ? 'active' : ''}}" 
          bindtap="switchTab" data-tab="overview">
      <text class="tab-text">æ¦‚è§ˆ</text>
    </view>
    <view class="tab-item {{selectedTab === 'records' ? 'active' : ''}}" 
          bindtap="switchTab" data-tab="records">
      <text class="tab-text">è®°å½•</text>
    </view>
    <view class="tab-item {{selectedTab === 'analytics' ? 'active' : ''}}" 
          bindtap="switchTab" data-tab="analytics">
      <text class="tab-text">åˆ†æ</text>
    </view>
  </view>

  <!-- æ¦‚è§ˆæ ‡ç­¾é¡µ -->
  <view class="tab-content" wx:if="{{selectedTab === 'overview'}}">
    <!-- ç›®æ ‡åŸºæœ¬ä¿¡æ¯ -->
    <view class="goal-info">
      <view class="info-header">
        <text class="goal-title">{{isEditing ? 'ç¼–è¾‘ç›®æ ‡' : 'ç›®æ ‡ä¿¡æ¯'}}</text>
      </view>
    
    <!-- ç›®æ ‡æ ‡é¢˜ -->
    <view class="info-section">
      <text class="section-title">ç›®æ ‡æ ‡é¢˜</text>
      <input wx:if="{{isEditing}}" 
             class="title-input" 
             value="{{goalData.title}}" 
             bindinput="onTitleChange"
             placeholder="è¯·è¾“å…¥ç›®æ ‡æ ‡é¢˜" />
      <text wx:else class="info-text">{{goalData.title}}</text>
    </view>

    <!-- ç›®æ ‡åˆ†ç±» -->
    <view class="info-section">
      <text class="section-title">ç›®æ ‡åˆ†ç±»</text>
      <picker wx:if="{{isEditing}}" 
              mode="selector" 
              range="{{categories}}" 
              range-key="name" 
              value="{{categoryIndex}}" 
              bindchange="onCategoryChange">
        <view class="picker-display">
          <text class="picker-text">{{categories[categoryIndex].name}}</text>
          <text class="picker-arrow">â–¼</text>
        </view>
      </picker>
      <text wx:else class="info-text">{{goalData.category}}</text>
    </view>

    <!-- ç›®æ ‡æè¿° -->
    <view class="info-section">
      <text class="section-title">ç›®æ ‡æè¿°</text>
      <textarea wx:if="{{isEditing}}" 
                class="description-input" 
                value="{{goalData.description}}" 
                bindinput="onDescriptionChange"
                placeholder="è¯·è¾“å…¥ç›®æ ‡æè¿°"
                auto-height />
      <text wx:else class="info-text">{{goalData.description}}</text>
    </view>

    <!-- ç›®æ ‡çŠ¶æ€å’Œå‰©ä½™å¤©æ•° -->
    <view class="info-section" wx:if="{{!isEditing}}">
      <text class="section-title">ç›®æ ‡çŠ¶æ€</text>
      <view class="status-section">
        <view class="status-item">
          <text class="status-label">å½“å‰çŠ¶æ€</text>
          <text class="status-value {{statusClass}}">{{goalData.status || 'è¿›è¡Œä¸­'}}</text>
        </view>
        <view class="status-item" wx:if="{{goalData.remaining_days !== undefined}}">
          <text class="status-label">å‰©ä½™å¤©æ•°</text>
          <text class="status-value {{remainingDaysClass}}">
            {{goalData.remaining_days > 0 ? goalData.remaining_days + 'å¤©' : 'å·²è¿‡æœŸ'}}
          </text>
        </view>
      </view>
    </view>

    <!-- æ—¶é—´è®¾ç½® -->
    <view class="info-section">
      <text class="section-title">æ—¶é—´è®¾ç½®</text>
      <view class="time-inputs-horizontal">
        <view class="time-input-horizontal">
          <text class="time-label-horizontal">å¼€å§‹æ—¶é—´</text>
          <picker wx:if="{{isEditing}}" 
                  mode="date" 
                  value="{{goalData.startDate}}" 
                  bindchange="onStartDateChange">
            <view class="picker-display-horizontal">
              <text class="picker-text-horizontal">{{goalData.startDate || 'è¯·é€‰æ‹©'}}</text>
              <text class="picker-arrow-horizontal">â–¼</text>
            </view>
          </picker>
          <text wx:else class="info-text-horizontal">{{goalData.startDate || 'æœªè®¾ç½®'}}</text>
        </view>
        
        <view class="time-input-horizontal">
          <text class="time-label-horizontal">ç»“æŸæ—¶é—´</text>
          <picker wx:if="{{isEditing}}" 
                  mode="date" 
                  value="{{goalData.endDate}}" 
                  bindchange="onEndDateChange">
            <view class="picker-display-horizontal">
              <text class="picker-text-horizontal">{{goalData.endDate || 'è¯·é€‰æ‹©'}}</text>
              <text class="picker-arrow-horizontal">â–¼</text>
            </view>
          </picker>
          <text wx:else class="info-text-horizontal">{{goalData.endDate || 'æœªè®¾ç½®'}}</text>
        </view>
      </view>
    </view>

    <!-- é‡åŒ–æŒ‡æ ‡ -->
    <view class="info-section">
      <text class="section-title">é‡åŒ–æŒ‡æ ‡</text>
      <view class="quantification-inputs-horizontal">
        <view class="quant-input-horizontal">
          <text class="quant-label-horizontal">ç›®æ ‡å€¼</text>
          <input wx:if="{{isEditing}}" 
                 class="value-input-horizontal" 
                 value="{{goalData.targetValue}}" 
                 bindinput="onTargetValueChange"
                 placeholder="ç›®æ ‡å€¼" />
          <text wx:else class="info-text-horizontal">{{goalData.targetValue || 'æœªè®¾ç½®'}}</text>
        </view>
        
        <view class="quant-input-horizontal">
          <text class="quant-label-horizontal">å½“å‰å€¼</text>
          <input wx:if="{{isEditing}}" 
                 class="value-input-horizontal" 
                 value="{{goalData.currentValue}}" 
                 bindinput="onCurrentValueChange"
                 placeholder="å½“å‰å€¼" />
          <text wx:else class="info-text-horizontal">{{goalData.currentValue || 'æœªè®¾ç½®'}}</text>
        </view>
        
        <view class="quant-input-horizontal">
          <text class="quant-label-horizontal">å•ä½</text>
          <input wx:if="{{isEditing}}" 
                 class="unit-input-horizontal" 
                 value="{{goalData.unit}}" 
                 bindinput="onUnitChange"
                 placeholder="å•ä½" />
          <text wx:else class="info-text-horizontal">{{goalData.unit || 'æœªè®¾ç½®'}}</text>
        </view>
      </view>
    </view>

    <!-- è¿›åº¦æ˜¾ç¤º -->
    <view class="info-section" wx:if="{{!isEditing && goalData.targetValue && goalData.currentValue}}">
      <text class="section-title">å½“å‰è¿›åº¦</text>
      <view class="progress-section">
        <view class="progress-bar">
          <view class="progress-fill" style="width: {{progressPercentage}}%"></view>
        </view>
        <text class="progress-text">{{progressPercentage}}%</text>
      </view>
    </view>

    <!-- ä¼˜å…ˆçº§ -->
    <view class="info-section">
      <text class="section-title">ä¼˜å…ˆçº§</text>
      <view wx:if="{{isEditing}}" class="priority-options">
        <view class="priority-item {{goalData.priority === 'high' ? 'selected' : ''}}" 
              bindtap="selectPriority" 
              data-priority="high">
          <text class="priority-icon">ğŸ”¥</text>
          <text class="priority-name">é«˜</text>
        </view>
        <view class="priority-item {{goalData.priority === 'medium' ? 'selected' : ''}}" 
              bindtap="selectPriority" 
              data-priority="medium">
          <text class="priority-icon">âš¡</text>
          <text class="priority-name">ä¸­</text>
        </view>
        <view class="priority-item {{goalData.priority === 'low' ? 'selected' : ''}}" 
              bindtap="selectPriority" 
              data-priority="low">
          <text class="priority-icon">ğŸŒ±</text>
          <text class="priority-name">ä½</text>
        </view>
      </view>
      <text wx:else class="info-text">
        <text wx:if="{{goalData.priority === 'high'}}">ğŸ”¥ é«˜</text>
        <text wx:elif="{{goalData.priority === 'medium'}}">âš¡ ä¸­</text>
        <text wx:elif="{{goalData.priority === 'low'}}">ğŸŒ± ä½</text>
        <text wx:else>æœªè®¾ç½®</text>
      </text>
    </view>

    <!-- æé†’è®¾ç½® -->
    <view class="info-section">
      <text class="section-title">æé†’è®¾ç½®</text>
      <view class="reminder-options">
        <view class="reminder-item">
          <text class="reminder-label">æ¯æ—¥æé†’</text>
          <switch wx:if="{{isEditing}}" 
                  checked="{{goalData.dailyReminder}}" 
                  bindchange="onDailyReminderChange" />
          <text wx:else class="info-text">{{goalData.dailyReminder ? 'å¼€å¯' : 'å…³é—­'}}</text>
        </view>
        
        <view class="reminder-item">
          <text class="reminder-label">æˆªæ­¢æé†’</text>
          <switch wx:if="{{isEditing}}" 
                  checked="{{goalData.deadlineReminder}}" 
                  bindchange="onDeadlineReminderChange" />
          <text wx:else class="info-text">{{goalData.deadlineReminder ? 'å¼€å¯' : 'å…³é—­'}}</text>
        </view>
      </view>
    </view>

    <!-- åˆ›å»ºæ—¶é—´ -->
    <view class="info-section">
      <text class="section-title">åˆ›å»ºæ—¶é—´</text>
      <text class="info-text">{{goalData.createdAt}}</text>
    </view>
  </view>

  <!-- ç¼–è¾‘æ¨¡å¼ä¸‹çš„ä¿å­˜æŒ‰é’® - å·²éšè—ï¼Œé€šè¿‡é¡¶éƒ¨å®ŒæˆæŒ‰é’®æ§åˆ¶ -->
  <!-- <view class="save-section" wx:if="{{isEditing}}">
    <button class="save-btn" bindtap="saveChanges">ä¿å­˜ä¿®æ”¹</button>
  </view> -->


  <!-- æœ€è¿‘è¿‡ç¨‹è®°å½• -->
  <view class="recent-records" wx:if="{{!isEditing && recentRecords.length > 0}}">
    <view class="section-header">
      <text class="section-title">æœ€è¿‘è®°å½•</text>
      <text class="view-all" bindtap="goToTimeline">æŸ¥çœ‹å…¨éƒ¨</text>
    </view>
    <view class="record-list">
      <view class="record-item" 
            wx:for="{{recentRecords}}" 
            wx:key="id"
            bindtap="viewRecordDetail"
            data-record="{{item}}">
        <view class="record-header">
          <view class="record-type {{item.record_type}}">
            <text class="type-icon">{{getTypeIcon(item.record_type)}}</text>
            <text class="type-name">{{getTypeName(item.record_type)}}</text>
          </view>
          <text class="record-time">{{formatTime(item.recorded_at)}}</text>
        </view>
        <text class="record-content">{{item.content}}</text>
        <view class="record-tags" wx:if="{{item.tags && item.tags.length > 0}}">
          <text class="tag" wx:for="{{item.tags}}" wx:key="*this">{{item}}</text>
        </view>
      </view>
    </view>
  </view>
  </view>

  <!-- è®°å½•æ ‡ç­¾é¡µ -->
  <view class="tab-content" wx:if="{{selectedTab === 'records'}}">
    <!-- å¿«é€Ÿè®°å½•æ“ä½œ -->
    <view class="quick-record-actions">
      <view class="action-title">å¿«é€Ÿè®°å½•</view>
      <view class="action-buttons">
        <button class="action-btn voice-btn" bindtap="showVoiceRecordModal">
          <text class="btn-icon">ğŸ¤</text>
          <text class="btn-text">è¯­éŸ³è®°å½•</text>
        </button>
        <button class="action-btn progress-btn" bindtap="showProgressUpdateModal">
          <text class="btn-icon">ğŸ“ˆ</text>
          <text class="btn-text">æ›´æ–°è¿›åº¦</text>
        </button>
      </view>
    </view>

    <!-- è¿‡ç¨‹è®°å½•åˆ—è¡¨ -->
    <view class="records-list">
      <view class="section-header">
        <text class="section-title">è¿‡ç¨‹è®°å½•</text>
      </view>
      <view class="record-list" wx:if="{{recentRecords.length > 0}}">
        <view class="record-item" 
              wx:for="{{recentRecords}}" 
              wx:key="id"
              bindtap="viewRecordDetail"
              data-record="{{item}}">
          <view class="record-header">
            <view class="record-type {{item.record_type}}">
              <text class="type-icon">{{getTypeIcon(item.record_type)}}</text>
              <text class="type-name">{{getTypeName(item.record_type)}}</text>
            </view>
            <text class="record-time">{{formatTime(item.recorded_at)}}</text>
          </view>
          <text class="record-content">{{item.content}}</text>
          <view class="record-tags" wx:if="{{item.tags && item.tags.length > 0}}">
            <text class="tag" wx:for="{{item.tags}}" wx:key="*this">{{item}}</text>
          </view>
        </view>
      </view>
      <view class="empty-records" wx:else>
        <text class="empty-icon">ğŸ“</text>
        <text class="empty-text">è¿˜æ²¡æœ‰è¿‡ç¨‹è®°å½•</text>
        <text class="empty-subtitle">å¼€å§‹è®°å½•ä½ çš„ç›®æ ‡å®ç°è¿‡ç¨‹</text>
      </view>
    </view>
  </view>

  <!-- åˆ†ææ ‡ç­¾é¡µ -->
  <view class="tab-content" wx:if="{{selectedTab === 'analytics'}}">
    <!-- è¿›åº¦åˆ†æ -->
    <view class="analytics-section">
      <view class="section-header">
        <text class="section-title">è¿›åº¦åˆ†æ</text>
      </view>
      
      <!-- è¿›åº¦ç»Ÿè®¡ -->
      <view class="progress-stats">
        <view class="stat-item">
          <text class="stat-number">{{progressPercentage}}%</text>
          <text class="stat-label">å®Œæˆè¿›åº¦</text>
        </view>
        <view class="stat-item">
          <text class="stat-number">{{goalData.remaining_days || 0}}</text>
          <text class="stat-label">å‰©ä½™å¤©æ•°</text>
        </view>
        <view class="stat-item">
          <text class="stat-number">{{recentRecords.length}}</text>
          <text class="stat-label">è®°å½•æ•°é‡</text>
        </view>
      </view>

      <!-- è¿›åº¦å›¾è¡¨ -->
      <view class="chart-section" wx:if="{{showChart}}">
        <view class="chart-title">è¿›åº¦è¶‹åŠ¿</view>
        <view class="chart-placeholder">
          <text class="chart-text">ğŸ“Š è¿›åº¦å›¾è¡¨</text>
          <text class="chart-subtitle">æ˜¾ç¤ºç›®æ ‡å®Œæˆè¿›åº¦çš„æ—¶é—´çº¿</text>
        </view>
      </view>

      <!-- è®°å½•ç±»å‹åˆ†å¸ƒ -->
      <view class="record-type-distribution">
        <view class="section-title">è®°å½•ç±»å‹åˆ†å¸ƒ</view>
        <view class="distribution-list">
          <view class="distribution-item" wx:for="{{chartData}}" wx:key="type">
            <view class="type-info">
              <text class="type-icon">{{getTypeIcon(item.type)}}</text>
              <text class="type-name">{{getTypeName(item.type)}}</text>
            </view>
            <view class="type-count">
              <text class="count-number">{{item.count}}</text>
              <text class="count-label">æ¡</text>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- è¯­éŸ³è®°å½•å¼¹çª— -->
  <view class="voice-modal" wx:if="{{showVoiceModal}}">
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">è¯­éŸ³è®°å½•</text>
        <view class="close-btn" bindtap="hideVoiceRecordModal">âœ•</view>
      </view>
      
      <view class="voice-section">
        <view class="{{voiceButtonClass}}"
              bindtouchstart="startVoiceRecord"
              bindtouchend="stopVoiceRecord">
          <view class="voice-icon">ğŸ¤</view>
          <text class="main-text">{{recordingText}}</text>
          <text class="sub-text">{{voiceHint}}</text>
        </view>
      </view>
      
      <view class="voice-tip">
        <text class="tip-text">æŒ‰ä½è¯´è¯ï¼Œæ¾å¼€ç»“æŸå½•éŸ³</text>
        <text class="tip-text">è¯­éŸ³å°†è‡ªåŠ¨è¯†åˆ«å¹¶æ·»åŠ ä¸ºè¿‡ç¨‹è®°å½•</text>
      </view>
    </view>
  </view>

  <!-- è¿›åº¦æ›´æ–°å¼¹çª— -->
  <view class="progress-modal" wx:if="{{showProgressModal}}">
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">æ›´æ–°è¿›åº¦</text>
        <view class="close-btn" bindtap="hideProgressUpdateModal">âœ•</view>
      </view>
      
      <view class="form-section">
        <view class="form-item">
          <text class="form-label">å½“å‰è¿›åº¦å€¼</text>
          <input class="form-input" 
                 type="number" 
                 value="{{progressValue}}" 
                 bindinput="onProgressValueChange"
                 placeholder="è¯·è¾“å…¥å½“å‰è¿›åº¦å€¼" />
        </view>
        
        <view class="form-item">
          <text class="form-label">å¤‡æ³¨è¯´æ˜</text>
          <textarea class="form-textarea" 
                    value="{{progressNote}}" 
                    bindinput="onProgressNoteChange"
                    placeholder="å¯é€‰ï¼šæ·»åŠ è¿›åº¦è¯´æ˜"></textarea>
        </view>
      </view>
      
      <view class="modal-actions">
        <button class="btn btn-secondary" bindtap="hideProgressUpdateModal">å–æ¶ˆ</button>
        <button class="btn btn-primary" bindtap="submitProgressUpdate">æäº¤</button>
      </view>
    </view>
  </view>

  <!-- åˆ é™¤æŒ‰é’®åŒºåŸŸ - åªåœ¨éç¼–è¾‘æ¨¡å¼ä¸‹æ˜¾ç¤º -->
  <view class="delete-section" wx:if="{{!isEditing}}">
    <button class="delete-btn" bindtap="deleteGoal">
      <text class="delete-icon">ğŸ—‘ï¸</text>
      <text class="delete-text">åˆ é™¤ç›®æ ‡</text>
    </button>
  </view>
</view>
