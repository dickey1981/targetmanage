# 快速修复指南 - 3分钟解决登录问题

## 🚀 快速修复步骤

### 步骤1: 微信开发者工具设置 (30秒)

1. 打开微信开发者工具
2. 点击右上角"详情"按钮
3. 在"本地设置"选项卡中
4. ✅ **勾选**"不校验合法域名、web-view（业务域名）、TLS版本以及HTTPS证书"

![设置位置](https://developers.weixin.qq.com/miniprogram/dev/image/devtools2/setting.png)

### 步骤2: 编译预览 (10秒)

1. 点击"编译"按钮
2. 等待编译完成
3. 查看小程序首页

### 步骤3: 测试登录 (30秒)

1. 点击"微信授权登录"按钮
2. 在弹出的授权窗口中点击"允许"
3. 等待登录成功

## ✅ 预期结果

如果一切正常，你应该看到：

1. **授权弹窗**: 显示"申请获取你的公开信息（昵称、头像等）"
2. **登录成功**: 显示"登录成功"提示
3. **进入首页**: 可以看到今日目标和语音输入按钮

## 🔍 如果还是失败？

### 检查1: 确认服务器正常运行

在浏览器或Postman中访问：
```
http://106.54.212.67:8000/health
```

应该返回：
```json
{
  "status": "healthy",
  "timestamp": "2025-01-01T00:00:00Z",
  "service": "智能目标管理系统",
  "version": "1.0.0"
}
```

### 检查2: 查看控制台日志

在微信开发者工具中：
1. 点击底部"Console"标签
2. 清空日志
3. 再次点击"微信授权登录"
4. 查看日志输出

**正常日志应该包含**:
```
👤 用户信息授权结果: {...}
✅ 获取到用户信息: {...}
🔐 开始登录流程
✅ 获取微信登录code成功
📡 发送登录请求到: http://106.54.212.67:8000/api/auth/wechat-login
```

**如果看到报错**:
- ❌ `request:fail` - 检查服务器是否运行
- ❌ `url not in domain list` - 检查是否勾选"不校验合法域名"
- ❌ `timeout` - 检查网络连接

### 检查3: 重启服务

如果服务器无响应，SSH连接到服务器执行：

```bash
# 查看服务状态
docker ps | grep targetmanage

# 重启后端服务
docker restart targetmanage_backend_lighthouse

# 查看日志
docker logs -f targetmanage_backend_lighthouse
```

## 📱 体验版测试

### 生成体验版

1. 在微信开发者工具中点击"上传"
2. 填写版本号（如 1.0.1）和描述
3. 上传成功

### 配置体验成员

1. 登录小程序后台 https://mp.weixin.qq.com/
2. 进入"成员管理" > "体验成员"
3. 添加测试人员的微信号

### 扫码测试

1. 在小程序后台"版本管理"中找到体验版二维码
2. 使用手机微信扫码
3. 测试登录功能

⚠️ **注意**: 体验版目前只能给体验成员使用，无法对外发布。

## 🎯 为什么会出现这些问题？

### 原因1: 域名配置不匹配

**问题**: 
- 代码中配置的是 `https://targetmanage.cn`
- 实际服务器是 `http://106.54.212.67:8000`

**已修复**: 
- 修改了 `wechat-miniprogram/config/env.js`
- 将生产环境地址改为实际IP

### 原因2: 手机号授权限制

**问题**:
- 手机号授权需要企业认证
- 开发者工具不完全支持

**已修复**:
- 改用微信用户信息授权
- 无需手机号也可使用

### 原因3: HTTP vs HTTPS

**问题**:
- 微信小程序要求使用HTTPS
- 当前服务器使用HTTP

**临时方案**:
- 开发工具中关闭域名校验
- 体验版中也可以使用

**长期方案**:
- 申请域名和SSL证书
- 配置HTTPS（发布前必须）

## 📞 仍然有问题？

如果按照上述步骤操作后仍然无法解决，请提供以下信息：

1. 微信开发者工具的控制台完整日志
2. 服务器端的日志（`docker logs targetmanage_backend_lighthouse`）
3. 访问 `http://106.54.212.67:8000/health` 的返回结果
4. 是在开发工具还是真机上测试

---

**版本**: v1.0.1-fix
**更新时间**: 2024-10-16

